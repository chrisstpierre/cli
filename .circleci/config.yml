version: 2.0
jobs:
  test:
    working_directory: ~/repo
    docker:
    - image: circleci/python:3.7.0-node
    steps:
    - checkout

    - run:
        name: install dependencies
        command: |
          pip install pipenv
          pipenv install --dev

    - run:
        command: |
          pipenv run pip install tox
          pipenv run tox .

    - run:
        name: collect coverage
        command: |
          bash <(curl -s https://codecov.io/bash)

    - store_artifacts:
        path: test-reports
        destination: test-reports

  release_pypi:
    docker:
    - image: circleci/python:3.7.0-node
    steps:
      - checkout
      - run:
          name: setup venv
          command: |
            pip install pipenv
            pipenv install --dev
      - run:
          name: sdist
          command: |
            pipenv run python setup.py sdist bdist_wheel --universal
      - run:
          name: upload
          command: |
            pipenv run twine upload dist/story-*
  release_brew:
    macos:
      xcode: "9.0"
    steps:
      - add_ssh_keys:
          fingerprints:
            - "8e:2f:db:cd:a7:a4:38:ca:c1:c3:8f:ef:fc:27:4a:93"
      - run:
          name: install or re-link brew
          command: |
            if [ -d /usr/local/Cellar ]; then
              for i in `ls /usr/local/Cellar/`; do echo "Re-linking $i"; brew link --force $i; done
            else
              /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
            fi
      - run:
          name: upgrade python
          command: brew upgrade python || echo "Python is already installed"
      - run:
          name: install virtualenv
          command: pip3 install virtualenv
      - checkout
      - run:
          name: change git name
          command: git config --global user.name "Storyscript Infrastructure"
      - run:
          name: change git email
          command: git config --global user.email infra@storyscript.io
      - run:
          name: create brew pr
          command: bash ./scripts/update_brew.sh $CIRCLE_TAG
  release_snap:
    docker:
      - image: ubuntu:18.04
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Snap
          command: ./snap/build.sh
      - run:
          name: install snap
          command: snap install story_${CIRCLE_TAG}_amd64.snap --dangerous
      - run:
          name: check version
          command: story version | grep ${CIRCLE_TAG}
#      - run:
#          name: snapcraft login
#          command: echo $SNAPCRAFT_LOGIN | snapcraft login --with -
#      - run:
#          name: snapcraft push
#          command: snapcraft push --release edge story_${CIRCLE_TAG}_amd64.snap
workflows:
  version: 2
  build-test-deploy:
    jobs:
    - test:
        filters:
          tags:
            only: /.*/
    - release_pypi:
        requires:
          - test
        filters:
          tags:
            only: /^[0-9]+\.[0-9]+\.[0-9]+$/
          branches:
            ignore: /.*/
    - release_snap:
        filters:
              tags:
                only: /.*/
        #requires:
          #- release_pypi
        #filters:
          #tags:
            #only: /^[0-9]+\.[0-9]+\.[0-9]+$/
          #branches:
            #ignore: /.*/
    - release_brew:
        requires:
        - release_pypi
        filters:
          tags:
            only: /^[0-9]+\.[0-9]+\.[0-9]+$/
          branches:
            ignore: /.*/
